---
#rmarkdown::render("05-ej/ej-appendix.Rmd")
knit: ( function(input, ...) {rmarkdown::render(input)}  )
title: "The Environmental Justice Movement's Impact in Agency Rulemaking"
subtitle: "Appendix and Replication Code" 
author: "Devin Judge-Lord"
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
source(here::here("code", "setup.r"))

knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=8.5, 
                      #fig.width = 4,
                      split = T,
                      fig.path='../figs/')

library(modelsummary)
library(marginaleffects)
library(fixest)
library(tidyverse)
library(broom)
library(magrittr)
library(tidytext)
library(knitr)
library(kableExtra)



select <- . %>% dplyr::select()

library(ggplot2); theme_set(theme_bw());
  options(
    ggplot2.continuous.color = "viridis",
    ggplot2.continuous.fill = "viridis"
  )
  scale_color_discrete <- function(...){
    scale_color_viridis_d(..., direction = -1, 
                          begin = 0, end = .6, option = "plasma")}
  scale_fill_discrete <- function(...){
    scale_fill_viridis_d(..., direction = -1, 
                         begin = 0, end = .6, option = "plasma")}
  
  scale_color_continuous <- function(...){
    scale_color_viridis_c(..., direction = -1, 
                          option = "plasma")}
  scale_fill_continuous <- function(...){
    scale_fill_viridis_c(..., direction = -1, 
                         option = "plasma")}
  
  

```

# Data

Replication data are available in SQL and Rdata at https://github.com/judgelord/rulemaking 

```{r data, fig.height=11, cache=FALSE}
# load(here::here("data", "rules.Rdata"))
# 
# rules_raw <- rules %>% distinct(document_type, docket_id, posted_date, id) %>% 
#   mutate(document_id = id)

load(here::here("data", "ej_data_clean.Rdata"))

rules %<>% ungroup() %>% 
  mutate(president2 = case_when(
        year > 1992 & year <1995 ~ "Clinton 1",
    year > 1994 & year <2001 ~ "Clinton 2",
    year > 2000 & year <2005 ~ "G.W. Bush 1",
    year > 2004 & year <2009 ~ "G.W. Bush 2",
        year > 2008 & year < 2013 ~ "Obama 1",
            year > 2012 & year < 2017 ~ "Obama 2",
    year > 2016 & year < 2021 ~ "Trump",
            year > 2020 & year < 2025 ~ "Biden"
  ))


rules$president2 %<>% factor(levels =   c("Clinton 1", "Clinton 2", "G.W. Bush 1",
                                           "G.W. Bush 2",
                                           "Obama 1",
                                           "Obama 2",
                                           "Trump",
                                           "Biden") )

rules$president %<>% factor(levels =   c("Clinton",
                                         "G.W. Bush",
                                           "Obama",
                                           "Trump",
                                           "Biden") )

```

Subsets of data:

```{r subsets}
# SUBSETTING -------------------------------------------
#TODO sensitivity analysis to inclusion criteria
rules %>% distinct(docket_id, ej_pr, ej_fr) %>% count(ej_pr, ej_fr) %>% kablebox()

# All proposed rules
allPR <- rules %>% 
  ungroup() %>% 
  # subset to final rules
  filter(document_type == "Proposed Rule")


# All final rules
allFR <- rules %>% 
  ungroup() %>% 
  # subset to final rules with an NPRM 
  filter(document_type == "Rule") %>%
  # direct to final rules
  mutate(direct = ifelse(docket_id %in% allPR$docket_id, "Draft Rule Published", "Direct to Final Rule"))

# drop non fr
allFR %<>% filter(!(ej_pr & !ej_fr))

# TODO more work could be done to weed out ANPRMs, SNPRMs, and, most importantly, "final rules" that are not final rules

ejcomments %>% count(docket_id, number_of_comments_received, sort = T) %>% arrange(-number_of_comments_received) %>% kablebox()
```

### Documents


```{r ej-data-documenttype, fig.height=3}
# ej-data-documenttype


# document type over time
rules %>% 
  ggplot() + 
  aes(x = year, fill = document_type) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Number of Documents",
       x = "",
       fill = "") + 
  scale_fill_viridis_d(option="cividis", begin = .3, end = .7, direction = -1, ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank())
```

### Draft Rules


```{r ej-data-ejpr, fig.height=3, fig.width=6}
# ej-data-ejpr

percent_year <- rules %>% 
  filter(document_type == "Proposed Rule") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
  count(year, ej_pr) %>% 
  tidyr::pivot_wider(values_from = n, names_from = ej_pr, id_cols = year) %>% 
  mutate(`EJ Addressed` = replace_na(`EJ Addressed`,0)) %>% 
  mutate(sum = `EJ Addressed` + `EJ Not Addressed`,
         percent = `EJ Addressed` / sum  ,
         percent = percent(percent, 1)) 

percent_year %>% 
  kablebox()





pr_percent <- rules %>% 
  mutate(has_final = docket_id %in% allFR$docket_id) %>% 
  filter(document_type == "Proposed Rule") %>% 
  mutate(addressed = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
    left_join(percent_year) 


pr_percent %>% 
  filter(year > 2004) %>% 
  count(president2, percent, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed == "EJ Not Addressed", percent, NA)), alpha=.7, vjust = 0) + 
  labs(y  = "All Proposed Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
  scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = -1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())
```

```{r ej-data-ejpr-long, fig.height=3}
# ej-data-ejpr-long
# pr over time, back to 1993
rules %>% 
  filter(document_type == "Proposed Rule") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
    left_join(percent_year) %>% 
  count(president2, percent, ej_pr, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = ej_pr, color = ej_pr) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(ej_pr == "EJ Not Addressed", percent, NA)), alpha=.7, vjust = 0) + 
  labs(y  = "All Proposed Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = -1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.1, .9),
        legend.background = element_blank())

# ej_pr over time
ejPR %>% 
  filter(!is.na(posted_date)) %>% 
  mutate(year = str_sub(posted_date,1,4)) %>%
  ggplot() + 
  aes(x = year) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Proposed Rules\nAddressing Environmental Justice",
       x = "") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank())
```

### Final rules

#### By year 

```{r ej-data-ejfr, fig.height=3}
#ej-data-ejfr

percent_year <- rules %>% 
  filter(document_type == "Rule") %>% 
  mutate(ej_fr = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  count(year, ej_fr) %>% 
  pivot_wider(values_from = n, names_from =  ej_fr, id_cols = year) %>% 
  mutate(sum = `EJ Addressed` + `EJ Not Addressed`,
         percent = `EJ Addressed` / sum,
         percent = percent(percent, 1),
         document_type = "Rule")

percent_year %>% 
  kablebox()



fr_percent <- rules %>% 
  mutate(has_pr = docket_id %in% allPR$docket_id) %>% 
  filter(document_type == "Rule") %>% 
  mutate(addressed = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  left_join(percent_year) 


# fr type over time
fr_percent %>% 
  count(president2, percent, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed == "EJ Not Addressed", percent, NA)), alpha=.7, vjust = 0) + 
  labs(y  = "All Final Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = -1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.1, .9),
        legend.background = element_blank())
```

### Draft and final rules



#### By year

```{r ej-data, fig.height=3, fig.width=5}
# ej-data
# 1 pr and fr type over time - BLANK
full_join(pr_percent, fr_percent) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  #geom_col(alpha = .7, position = "dodge", color = NA) + 
  #geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free_x"
               ) + 
  scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())

# 2 fr type over time
fr_percent %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  #geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free_x"
               ) + 
  scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())


# 3 pr and fr type over time + percent 
fr_percent %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
    labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free_x"
               ) + 
  scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())


# pr and fr type over time
full_join(pr_percent, fr_percent) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  #geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(document_type ~ president2, scales = "free_x"
               ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())

# pr and fr type over time
full_join(pr_percent, fr_percent) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(document_type ~ president2, scales = "free_x"
               ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())

# ONLY MATCHED PAIRS 
full_join(pr_percent %>% filter(has_final), 
          fr_percent %>% filter(has_pr)) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "Draft and Final Pairs",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(document_type ~ president2, scales = "free_x"
               ) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank())
```

#### By president 
```{r ej-data-president, fig.height=3, fig.width=5}
percent_president <- rules %>% #filter(docket_id %in% allPR$docket_id) %>% 
  filter(document_type == "Proposed Rule") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
  count(president2, ej_pr) %>% 
  pivot_wider(values_from = n, names_from = ej_pr, id_cols = president2) %>% 
  mutate(sum = `EJ Addressed` + `EJ Not Addressed`,
         percent = `EJ Addressed` / sum ,
         percent = percent(percent, .1)
         ) 

percent_president %>% 
  kable (caption = "Proposed rules") %>% 
  kable_paper()

#FIXME somehow getting multiple percents per president 
pr_percent_president <- rules %>% 
  mutate(has_final = docket_id %in% allFR$docket_id) %>% 
  filter(document_type == "Proposed Rule") %>% 
  mutate(addressed = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
    left_join(percent_president) 


percent_president <- rules %>% #filter(docket_id %in% allFR$docket_id) %>%
  mutate(ej_pr = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
  count(president2, ej_pr) %>% 
  pivot_wider(values_from = n, names_from =  ej_pr, id_cols = president2) %>% 
  mutate(sum = `EJ Addressed` + `EJ Not Addressed`,
         percent = `EJ Addressed` / sum ,
         percent = percent(percent, .1)) 

percent_president %>% 
  kable (caption = "Final rules") %>% 
  kable_paper()


#FIXME somehow getting multiple percents per president 
fr_percent_president <- rules %>% 
  mutate(has_pr = docket_id %in% allPR$docket_id) %>% 
  filter(document_type == "Rule") %>% 
  mutate(addressed = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  left_join(percent_president) 


# ej-data
# 1 pr and fr type over time - BLANK
full_join(pr_percent_president, fr_percent_president) %>% 
  filter(year > 2004) %>% 
  ungroup() %>%
  count(president2, percent,document_type, addressed) %>% 
  ggplot() + 
  aes(x = president2, y = n, fill = addressed, color = addressed) +
  #geom_col(alpha = .7, position = "dodge", color = NA) + 
  #geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free_x"
               ) + 
  #scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank(),
        axis.text.x.bottom  = element_blank(),
        axis.ticks.x = element_blank())



# 2 pr and fr type over time - PRESIDENT 
full_join(pr_percent_president, 
          fr_percent_president
) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed) %>% 
  ggplot() + 
  aes(x = president2, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  #geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52, size =2.5) + 
  labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(document_type ~ president2, scales = "free_x"
               ) + 
  #scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank(),
        axis.text.x.bottom  = element_blank(),
        axis.ticks.x = element_blank())

# 2 pr and fr type over time - PRESIDENT 
full_join(pr_percent_president, #%>% filter(has_final), 
          fr_percent_president #%>% filter(has_pr)
) %>% 
  filter(year > 2004) %>% 
  count(president2, percent,document_type, addressed) %>%  #filter(addressed != "EJ Not Addressed")
  ggplot() + 
  aes(x = president2, y = n, fill = addressed, color = addressed) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(addressed != "EJ Not Addressed", percent, NA)), alpha=.7, vjust = -1, hjust = .52) + 
  labs(y  = "Agency Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1, guide = "none") + 
    facet_grid(document_type ~ president2, scales = "free_x"
               ) + 
  #scale_y_continuous(limits = c(0,2000)) + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.16, .9),
        legend.background = element_blank(),
        axis.text.x.bottom  = element_blank(),
        axis.ticks.x = element_blank())
```

```{r ej-data-ejfr-long, fig.height=3}

# fr type over time, back to 1993
rules %>% 
  filter(document_type == "Rule") %>% 
  mutate(ej_fr = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  left_join(percent_year) %>% 
  count(president2, percent, ej_fr, year) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = ej_fr, color = ej_fr) +
  geom_col(alpha = .7, position = "dodge", color = NA) + 
  geom_text(aes(label = ifelse(ej_fr == "EJ Not Addressed", percent, NA)), alpha=.7, vjust = 0) + 
  labs(y  = "All Final Rules",
       x = "",
       fill = "")+ # "EJ Addressed\nin Proposed Rule") + 
  scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
     scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = -1, guide = "none") + 
    facet_grid(. ~ president2, scales = "free") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        legend.position = c(.1, .9),
        legend.background = element_blank())


# ej_fr over time
ejFR %>% 
  filter(!is.na(posted_date)) %>% 
  mutate(year = str_sub(posted_date,1,4)) %>%
  ggplot() + 
  aes(x = year) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Final Rules\nAddressing Environmental Justice",
       x = "") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank())



```


### Agencies that published at least 1 rule addressing EJ

Subsetting to agencies that pubished at least one rule explicitly addressing EJ from 1992 through 2020 yields
 `r allPR %>% distinct(docket_id, comments) %>% summarize(n = sum(comments)) %>% pull(n)` public comments on
 `r allFR %>% distinct(docket_id) %>% nrow()` rulemaking dockets from
`r rules %>% distinct(agency) %>% nrow()` agencies, each publishing at least one rule that explicitly addressed environmental justice. `r sum(ejcomments$number_of_comments_received)` comments mentioning EJ, including  `r ejcomments %>% nrow()` unique comments (excluding duplicates) use the phrase "environmental justice". 



```{r ej-data-agencies}
share <- allPR %>%
  distinct(ej_pr, docket_id, agency) %>% 
  group_by(agency) %>% 
  summarise(agency_ej_share = sum(ej_pr)/ n() )  %>% 
  arrange(-agency_ej_share) 
  
  share %>% 
    mutate(agency_ej_share = percent(agency_ej_share, accuracy = .1)) %>%
    kablebox()
  
rules %<>% ungroup() %>% 
  dplyr::select(-agency_ej_share) %>%  left_join(share)

# president share 
share_president <- allPR %>%
  distinct(ej_pr, docket_id, president) %>% 
  group_by(president) %>% 
  summarise(ej_share_president = sum(ej_pr)/ n() )  %>% 
  arrange(-ej_share_president) 

share_president %>% 
    mutate(ej_share_president = percent(ej_share_president, accuracy = .1)) %>%
    kablebox()
  
rules %<>% ungroup() %>% 
   left_join(share_president )

# agency + president share 
share_president_agency <- allPR %>%
  distinct(ej_pr, docket_id, agency, president) %>% 
  group_by(agency, president) %>% 
  summarise(agency_ej_share_president = sum(ej_pr)/ n() )  %>% 
  arrange(-agency_ej_share_president) 
  
share_president_agency %>% 
    mutate(agency_ej_share_president = percent(agency_ej_share_president, accuracy = .1))  %>% 
  #arrange(-agency_ej_share_president) %>%
    kablebox()
  
rules %<>% ungroup() %>% 
   left_join(share_president_agency)


#ej-data-agencies
breaks <-  c("`16", 
             "`00", "`04", "`08", "`20", "`24")

allFR %>%
  filter(year > 2004) %>%
  mutate(ej_fr = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  ggplot() + 
  aes(x = Year, fill = factor(ej_fr, levels = c("EJ Not Addressed", "EJ Addressed"))) +
  facet_wrap("agency", scales = "free_y") +
  geom_bar(alpha = .7) +
  labs(fill = "EJ in Final Rule",
       x = "",
       y = "")+ 
  scale_fill_discrete()+#direction = -1) + 
  scale_x_discrete(breaks = breaks ) 
```

### Agencies that received at least 100 unique EJ comments


```{r ej-data-agencies100, fig.height=6.7, fig.width=6.5}
# ej-data-agencies100

col_label = str_wrap('Even at the Environmental Protection Agency (EPA), where most policies are clearly framed as "environmental" issues, only about half of final rules address EJ. Many agencies that make policy with apparent EJ effects almost never address EJ. These include the Fish and Wildlife Service (FWS), Department of Housing and Urban Development (HUD), National Oceanic and Atmospheric Administration (NOAA), Nuclear Regulatory Commission (NRC), and the Office of Surface Mining (OSM). At no agency did a majority of rules address EJ overall. Only in a handful of years at agencies that publish few rules was EJ addressed in most rules. These include the Council on Environmental Quality (CEQ), Army Corps of Engineers (COE), Federal Emergency Management Agency (FEMA), Forest Service (FS), and several Department of Transportation agencies (the Federal Highway Administration (FHWA), Federal Motor Carrier Safety Administration (FMCSA), Federal Railroad Administration (FRA), and Federal Transit Administration (FTA).',100)


breaks <-  c("`16", "`12", 
             "`00", "`04","`08", "`92",  "`96", "`20", "`24")
# agencies that published at least 100 rules with ej comments
allFR %>% 
  filter(agency_ej_comments > 100 | agency_ej_rules > 10 | agency == "FEMA",
         year > 2004) %>% 
  mutate(ej_fr = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  ggplot() + 
  aes(x = Year, fill = factor(ej_fr, levels = c("EJ Not Addressed", "EJ Addressed"))) +
  scale_fill_discrete()+#direction = -1) + 
  facet_wrap("agency", scales = "free_y") +
  geom_bar(alpha = .7) + 
  labs(fill = "\"Environmental Justice\"\nin Final Rule",
       y = "Number of Rules",
       caption = col_label) + 
    theme(legend.position = "bottom",
      plot.caption = element_text(hjust = 0)) + # set the left align here
  scale_x_discrete(breaks = breaks ) +
  scale_y_continuous(breaks= pretty_breaks())
  # scale_y_continuous(breaks = function(x) if(x<5){seq(ceiling(x[1]), floor(x[2]), by = 1)} else{pretty_breaks()})




```



## Draft Rules by President

```{r ej-pr-president, fig.height=2.5}
#ej-pr-president

allPR %>% 
  filter(president2 %in% c("Bush 2", "Obama 1", "Obama 2", "Trump")) %>% 
  count(Year, ej_pr, president2) %>%
    mutate(ej_pr = ifelse(ej_pr, "EJ Addressed", "EJ Not Addressed")) %>% 
  ggplot() + 
  aes(x = Year, y =n,
      fill = factor(ej_pr, levels = c("EJ Not Addressed", "EJ Addressed"))) +
  scale_fill_discrete()+#direction = -1) + 
  geom_col(alpha = .7, position = "dodge") + 
  facet_grid(. ~ president2, scales = "free") + 
  labs(x = "Year",
       y = "Number of Proposed Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank())
```


## Final Rules by President



```{r ej_fr-president, fig.height=4.5, ,fig.width=6.5}
# ej_fr-president

allFR %>% 
   filter(president2 %in% c("G.W. Bush 2", "Obama 1", "Obama 2", "Trump")) %>%
  count(Year, ej_fr, direct, president2) %>%
    mutate(ej_fr = ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed")) %>% 
  ggplot() + 
  aes(x = Year, y = n,
      fill = factor(ej_fr, levels = c("EJ Not Addressed", "EJ Addressed"))) +
  scale_fill_discrete()+#direction = -1) + 
  geom_col(alpha = .7, position = "dodge") + 
  facet_grid(direct ~ president2, scales = "free") + 
  labs(x = "Year",
       y = "Number of Final Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank())

allFR %>% 
   filter(president2 %in% c("G.W. Bush 2", "Obama 1", "Obama 2", "Trump")) %>%
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final Rule", "EJ Only in Final Rule"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  count(Year, ej_pr, ej_comment, president2) %>% 
  mutate(ej_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = Year, y = n,
      fill = factor(ej_comment, levels = c("No Comments Address EJ", "Comments Address EJ"))) +
  scale_fill_discrete()+#direction = -1) + 
  geom_col(alpha = .7) + 
  facet_grid(ej_pr ~ president2, scales = "free") + 
  labs(x = "",
       y = "Number of Rules",
       fill = "Comments Raised\nEnvironmental\nJustice Concerns") + 
  theme(panel.grid.major.x = element_blank())


# full time period back to 1992
allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final Rule", "EJ Only in Final Rule"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  count(Year, ej_pr, ej_comment, president) %>% 
  mutate(ej_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = Year, y = n,
      fill = factor(ej_comment, levels = c("No Comments Address EJ", "Comments Address EJ"))) +
  scale_fill_discrete()+#direction = -1) + 
  geom_col(alpha = .7) + 
  facet_grid(ej_pr ~ president, scales = "free") + 
  labs(x = "",
       y = "Number of Rules",
       fill = "Comments Raised\nEnvironmental\nJustice Concerns") + 
  theme(panel.grid.major.x = element_blank())
```

---

## Comments 

### by President



```{r ej-comments-added,fig.width=6.5, fig.height=3}
# ej_comments
breaks <- c(1996, 2000, 2004, 2006, 2008, 2010, 2012, 2014, 2016, 2018, 2020)

# COMPARISON 1: no ej vs ej added 
allFR %>% 
      filter(ej_pr == F) %>% 
  filter(president2 %in% c("G.W. Bush 2", "Obama 1", "Obama 2", "Trump")) %>%
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final", "EJ Only in Final"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = year, color = EJ_comment, shape = EJ_comment) + 
  # plot ej comments on top
  geom_jitter(alpha = .3, 
              aes(y = ifelse(ej_comment, NA, comments) ) ) + 
  geom_jitter(alpha = .3,
              aes(y = ifelse(ej_comment, comments, NA) ) ) +
  #geom_jitter(alpha = .3) + 
  facet_grid(ej_pr ~ president2, scales = "free_x") + 
  scale_y_log10(labels = scales::comma)  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Total Number of Comments\nper Rule (log scale)",
       color = "Comments Raised\nEnvironmental\nJustice Concerns",
       shape = "Comments Raised\nEnvironmental\nJustice Concerns") +
  #scale_x_discrete(breaks = breaks) + 
  scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  theme(axis.text.x = element_text(angle = 45, hjust =1) )

```


```{r ej-comments,fig.width=6.5, fig.height=4.1}
allFR %>% 
  filter(president2 %in% c("G.W. Bush 2", "Obama 1", "Obama 2", "Trump")) %>%
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final", "EJ Only in Final"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = year, color = EJ_comment, shape = EJ_comment) + 
  # plot ej comments on top
  geom_jitter(alpha = .3, 
              aes(y = ifelse(ej_comment, NA, comments) ) ) + 
  geom_jitter(alpha = .3,
              aes(y = ifelse(ej_comment, comments, NA) ) ) +
  #geom_jitter(alpha = .3) + 
  facet_grid(ej_pr ~ president2, scales = "free_x") + 
  scale_y_log10(labels = scales::comma)  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Total Number of Comments per Rule (log scale)",
       color = "Comments Raised\nEnvironmental\nJustice Concerns",
       shape = "Comments Raised\nEnvironmental\nJustice Concerns") +
  #scale_x_discrete(breaks = breaks) + 
  scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  theme(axis.text.x = element_text(angle = 45) )


# full time period back to 1992
breaks <- c(1996, 2000, 2004, 2008, 2012, 2016, 2020)

allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final", "EJ Only in Final"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = year, color = EJ_comment, shape = EJ_comment) + 
  # plot ej comments on top
  geom_jitter(alpha = .3, 
              aes(y = ifelse(ej_comment, NA, comments) ) ) + 
  geom_jitter(alpha = .3,
              aes(y = ifelse(ej_comment, comments, NA) ) ) +
  #geom_jitter(alpha = .3) + 
  facet_grid(ej_pr ~ president, scales = "free_x") + 
  scale_y_log10(labels = scales::comma)  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Total Number of Comments per Rule (log scale)",
       color = "Comments Raised\nEnvironmental\nJustice Concerns",
       shape = "Comments Raised\nEnvironmental\nJustice Concerns") +
  scale_x_discrete(breaks = breaks) + 
  scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  +
  theme(axis.text.x = element_text(angle = 45) )

```

# By Organization 

```{r ej-orgs}
#ej-orgs
here::here("code", "clean_orgs.R") |> 
  str_replace("University of Michigan Dropbox/Devin Judge-Lord/ej", 
              "dissertation") |> 
  source() 


ejorgs <- ejcomments %>% 
  drop_na(organization) %>% 
  filter(!organization %in% c("NA")) %>% 
   mutate(org_name = organization %>% clean_orgs()) %>% 
  group_by(org_name) %>% 
  mutate(Dockets = docket_id %>% unique() %>% length()) %>% 
  group_by(org_name, Dockets) %>% 
  summarise(unique = n(),
            total = sum(number_of_comments_received)) %>% 
  arrange(-total) 


# total from top 100 ejorgs
ejorgs %<>% 
  filter(!str_dct(org_name, "unknown|404error|broken link|anonymous|knowwho")) 


# FORMAT FOR PRESENTATION 
ejorgs %<>% mutate(org_name = ifelse(nchar(org_name)<10, str_to_upper(org_name), org_name) )

ejorgs_summary <- ejorgs %>% 
  ungroup() %>%
  filter(!str_dct(org_name, "^NA$|unknown|individuals|n/a|^N$")) %>%
  arrange(-Dockets)   %>% 
  rename(Organization = org_name, 
         `Unique EJ Comments` = unique,
         `Total EJ Comments` = total) 

# need to do better
nrow(ejorgs_summary)
ejorgs_summary$`Total EJ Comments` %>% sum()


save(ejorgs_summary, file =  here("data", "ejorgs_summary.Rdata"))

ejorgs_summary %>% 
  kablebox() #%>% kable3(caption = "Organizations Mobilizing the Most Public Comments 2005-2020")


ejorgs_summary %>% 
  arrange(-`Total EJ Comments`) %>% 
  kablebox() 

ejorgs_FR <- ejcomments %>%
  mutate(docket_id =str_remove(id, "-[0-9]*$")) %>%
  #select(docket_id)
  filter(docket_id %in% allFR$docket_id) %>%
  drop_na(organization) %>%
  filter(!organization %in% c("NA")) %>%
  group_by(organization, docket_id) %>%
  #add_count(docket_id) %>% #TODO
  summarise(unique = n(),
            total = sum(number_of_comments_received)) %>%
  ungroup() %>% 
  arrange(-total)

# per docket 
ejorgs_FR %>%
  kablebox()


# number of dockets 
ejorgs_FR %>%
  count(organization, name = "dockets on which org raised EJ", sort = T) %>% 
  kablebox()


# 
# ejorgs

```

---

# Proposed rules that **did not** address EJ

```{r}
# allFR %<>% mutate(agency_ej_share = agency_ej_share*100)

# Final Rules that where ej was not mentioned in the NPRM
ejFR_PR <- allFR %>% 
  filter(docket_id %in% allPR$docket_id, # there is an NPRM
         !ej_pr) # ej is not in it

save(ejFR_PR, file = here::here("data", "ejFR_PR.Rdata"))
```

Percent where the final rule did address EJ


```{r ej-PR-winrate, fig.width=6, fig.height=2}
#ej-PR-winrate 

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  left_join(winrate) %>%
  group_by(ej_comment) %>% 
  mutate(mean = mean(c(`TRUE`, `FALSE`)),
         EJ_fr = ej_fr,#ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed"),
        EJ_comment = ifelse(ej_comment, "EJ Raised by Commenters", "EJ not Raised by Commenters")) %>% 
  ggplot() + 
  aes(x = EJ_comment, 
      y = n, 
      fill = EJ_fr, 
      label = ifelse(ej_fr == ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(y = mean)) + 
  facet_wrap("EJ_comment", scales = "free") + 
  labs(fill = "EJ in Final Rule",
       y = "Proposed Rules") + 
  #scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = -1) +
  theme_void() +
  theme(axis.text.y = element_text(),
        axis.title.y = element_text(angle = 90),
        panel.grid.major.y = element_line(color = "grey"))
```


## By president


```{r ej-PR-winrate-president, fig.height=3, fig.width=6}
#ej-PR-winrate-president

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments"),
         EJ_fr = ej_fr# ifelse(ej_fr, "EJ Addressed", "EJ Not Addressed") 
         ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = EJ_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ in Final Rule",
       x = "Proposed Rules that Did Not Address EJ",
       y = "",
       title = "Rates of Rule Change by President") + 
  #scale_fill_viridis_d(option="plasma", begin = 0, end = .6, direction = 1) + 
  #theme_void() +
  theme(axis.text.x = element_text(angle = 30),
        panel.grid.major.y = element_blank())

# 
# ejFR_PR %>% 
#   ggplot() + 
#   aes(x = log(ej_comments_unique+1), y = log(comments+1)) + 
#   geom_jitter() + 
#   geom_smooth()
```


## Model 

### With president indicators

```{r ej-m-PR}
# ej-m-PR

m_PR <- glm(ej_fr ~ ej_comment*log(comments+1) +
              log(ej_comments_unique+1) +
              president,
           data = ejFR_PR, 
             family=binomial(link="logit"))

equatiomatic::extract_eq(m_PR)

m_PRa <- glm(ej_fr ~ ej_comment*log(comments+1) +
              log(ej_comments_unique+1) +
              president + agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))


# ej-m-PR-comments-agencyFE

# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_pres <- feglm (ej_fr ~ ej_comment + #*log(comments+1) + 
                          log(ej_comments_unique+1)  + 
                      president
                        | agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_presI <- feglm (ej_fr ~ ej_comment*president + 
                          log(ej_comments_unique+1) 
                        | agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_presIshare <- feglm (ej_fr ~ ej_comment*president + agency_ej_share + president + 
                          log(ej_comments_unique+1) ,
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_presIshareI <- feglm (ej_fr ~ ej_comment*president + 
                             ej_comment*agency_ej_share+
                          log(ej_comments_unique+1) ,
           data = ejFR_PR, 
             family=binomial(link="logit"))


m_PR_pres2 <- feglm (ej_fr ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 + 
                       president
                        |  agency,
           data = ejFR_PR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))



modelsummary(list(m_PR, m_PR_pres, m_PR_pres2), stars = T)
```

### With president fixed effects

```{r ej-m-PRFE}
# ej-m-PR
m_PRFE <- feglm(ej_fr ~ ej_comment*log(comments+1) +
              log(ej_comments_unique+1) | president,
           data = ejFR_PR, 
             family=binomial(link="logit"))


modelsummary(m_PRFE, stars = T)
```


With the median number of comments on Proposed Rules that did not address EJ, `r median(ejFR_PR$comments)` comments:

For presentation

```{r ej-m-PR-median-pres, fig.width=3, fig.height=3}
# ej-m-PR-president-median

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comment = T,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president = "Obama",
         agency = c("EPA", "PHMSA")) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment))

predicted <- predictions(m_PR_pres,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))

# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
    legend.position = "none",
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  + ylim(0,1) 

p 

p$layers[1] <- NULL

p + ylim(0,1) 

### VERSION 2 WITH AGENCY INDICATORS 

predicted <- predictions(m_PRa,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))



# As a plot
predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
    legend.position = "none",
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") # +ylim(0,1) 


```

### Predicted Probabilities by President


With the median number of comments on Proposed Rules that did not address EJ, `r median(ejFR_PR$comments)` comments:

For presentation

```{r ej-m-PR-president-median-pres, fig.width=3, fig.height=3}
# ej-m-PR-president-median-pres 

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comment = TRUE,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president,
         agency = c("EPA", "PHMSA")) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment))

predicted <- predictions(m_PR_pres,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))

# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
    # text = element_text(family = "Open Sans"),
    legend.position = "none", 
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  + ylim(0,1) 

p

### VERSION 2 WITH AGENCY INDICATORS 

predicted <- predictions(m_PRa,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))



# As a plot
predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
    legend.position = "none",
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") # +ylim(0,1) 

p 

p$layers[1] <- NULL

p + ylim(0,1) 

```

---

```{r ej-m-PR-president-median, fig.width=6, fig.height=3}
# ej-m-PR-president-median

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president,
         agency = c("EPA", "PHMSA")) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment))

predicted <- predictions(m_PR_pres,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))

# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  + ylim(0,1) 

p 

### VERSION 2 WITH AGENCY INDICATORS 

predicted <- predictions(m_PRa,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


predicted %<>%
  mutate(agency = agency %>% 
           str_replace("EPA" , "Environmental Protection Agency") %>% 
           str_replace("PHMSA", "Pipeline & Hazardous Materials\nSafety Administration"))



# As a plot
predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7, position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") # +ylim(0,1) 


```



---

With the **mean** number of comments on Proposed Rules that did not address EJ, `r mean(ejFR_PR$comments) %>% round()` comments:

```{r ej-m-PR-president-mean, fig.width=6, fig.height=3}
# ej-m-PR-president-mean

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = mean(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         president,
         agency = c("EPA", "PHMSA")) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment))

predicted <- predictions(m_PR_pres,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = president, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  ylim(0,1) 
```


---

## By total number of comments

For presentation

```{r ej-m-PR-comments-pres, fig.width=3, fig.height=2.5}
# ej-m-PR-comments-pres 

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama")

predicted <- augment(m_PR,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
p <-predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
#facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "Public Attention \n (Number of Comments)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        legend.position = "none",
        panel.grid.major.y = element_blank()) 

p 

p$layers[1] <- NULL

p + ylim(0,1) 
```


---

## By total number of comments

```{r ej-m-PR-comments, fig.width=6, fig.height=2.5}
# ej-m-PR-comments

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama")

predicted <- augment(m_PR,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
#facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---

## By Agency 

The percent of rules where EJ was added

```{r ej-PR-winrate-agency, fig.height=3, fig.width=6}
#ej-PR-winrate-agency

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, agency) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 )) %>% 
  ungroup() %>% 
  arrange(agency)

winrate %>% filter(ej_comment == F) %>% kablebox()

winrate %>% filter(ej_comment == T) %>% kablebox()

# winrate 
ejFR_PR %>% count(agency, ej_comment, ej_fr)  %>% 
  add_count(agency) %>% 
  filter(nn > 3) %>% 
  #filter(agency == "EPA") %>%
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = ej_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7 , position = position_dodge(width = 0.40) ) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("agency", scales = "free")+ 
  labs(fill = "EJ in Final Rule",
       x = "Proposed Rules that Did Not Address EJ",
       y = "",
       title = "Rates of Rule Change by Agency") + 
  theme(axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 30),
        panel.grid.major.y = element_blank())
```

### Models

```{r}
m_PR_agency <- glm(ej_fr ~ ej_comment*log(comments+1) + 
                     log(ej_comments_unique+1) + #TODO remove or transform 
                     president + 
                     agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_agency <- glm(ej_fr ~ ej_comment*log(comments+1) + 
                     log(ej_comments_unique+1) + #TODO remove or transform 
                     president + 
                     agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

# modelsummary(m_PR_agency, stars =  T)
```

### Predicted Probabilies by Agency
```{r ej-m-PR-agency, fig.height=9}
# ej-m-PR-agency

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>%
  tidyr::expand(ej_comment,
         president = "Obama",
         ej_comments_unique = median(comments) %>% round(),
         comments = median(comments) %>% round(),
         agency)

predicted <- broom::augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency)) %>% arrange(Agency)


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7 , position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  
#facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments', 
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  scale_y_continuous(breaks = c(0, .5,1)) +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank()) 
```

Agencies with at least 300 comments on proposed rules that did not mention environmental justice (i.e., agencies where at least some of the rules in this dataset saw comments) and at least 3 rules where comments raised EJ concerns (i.e., agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-top, fig.width=7}
# ej-m-PR-agency-top

ejFR_PR %>% group_by(agency) %>% count(agency, agency_ej_comments,sum(comments) )  %>%   kablebox()


top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=300,
         agency_ej_comments >=3) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7 , position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  scale_y_continuous(breaks = c(0, .5,1)) +
labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule',
     x = "",
     color = "",#color = '"Environmental Justice"\nRaised by Comments', 
     shape = "",#shape = "Environmental Justice"\nRaised by Comments', 
     title = "Predicted Change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        panel.border  = element_blank())
```


A more selective subset: Agencies that have at least 500 comments on proposed rules that did not mention environmental justice (i.e., agencies where at least some of the rules in this dataset saw more than a few comments) and at least 50 rules where comments raised EJ concerns (i.e., agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-toptop, fig.height=3, , fig.width=6}
# ej-m-PR-agency-toptop

# slightly more selective, requiring 100 comments
top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=500,
         agency_ej_comments >=50) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7 , position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  scale_y_continuous(breaks = c(0, .5,1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank())
```

### with Agency Share

(as well as President FE)


For presentation
```{r ej-m-PR-comments-share-pres, fig.width=3, fig.height=2.5}
# ej-m-PR-comments-share-pres 


# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_share <- feglm (ej_fr ~ ej_comment*log(comments+1) + 
                          log(ej_comments_unique+1) +
                       agency_ej_share
                        | president , 
                     #se = "twoway",
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_share2 <- feglm (ej_fr ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 +
                           agency_ej_share 
                        | president, 
                        #se = "twoway",
           data = ejFR_PR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))


# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments = c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency_ej_share = 0.41,
         agency = "EPA") %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment)) 



predicted <- predictions(m_PR_share,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%  
           str_c("\n     (N = ", pretty_num(n_ej_comment)," Rules)"))


# As a plot
p <- predicted %>%
  # make responsiveness 
  mutate(predicted = estimate - lag(estimate)) %>% 
  filter(comments<10001, ej_comment) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , 
                  position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "Public Attention\n(Number of Comments)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        legend.position = "none",
        panel.grid.major.y = element_blank())

p 

p$layers[1] <- NULL

p + ylim(0,1) 
```

```{r ej-m-PR-comments-share-pres2, fig.width=5, fig.height=2.5}
# As a plot
p <- predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Public Attention\n(Number of Comments)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank())

p

```


For paper 
```{r ej-m-PR-comments-share, fig.width=6, fig.height=2.5}
# ej-m-PR-comments-share

# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_share <- feglm (ej_fr ~ ej_comment*log(comments+1) + 
                          log(ej_comments_unique+1) +
                       agency_ej_share
                        | president , 
                     #se = "twoway",
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_share2 <- feglm (ej_fr ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 +
                           agency_ej_share 
                        | president, 
                        #se = "twoway",
           data = ejFR_PR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(m_PR_share, m_PR_share2), stars = T)

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments = c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency_ej_share = 0.41,
         agency = "EPA") %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment)) 



predicted <- predictions(m_PR_share,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank())
```


```{r ej-m-PR-ejcomments-share, fig.width=6, fig.height=2.5}
# ej-m-PR-ejcomments-share


# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency_ej_share = 0.41,
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)



# predicted <- broom::augment(m_PR_share,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      )  


predicted <- predictions(m_PR_share,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate, 
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment)) 

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```


---


### with Agency Share Interaction

(as well as President FE)

```{r ej-m-PR-shareI, fig.width=6, fig.height=3}
# ej-m-PR-comments-shareI

# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_shareI <- feglm (ej_fr ~ ej_comment*log(comments+1) + 
                          log(ej_comments_unique+1) +
                       ej_comment*agency_ej_share
                        | president , 
                     #se = "twoway",
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_shareI2 <- feglm (ej_fr ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 +
                           ej_comment*agency_ej_share 
                        | president, 
                        #se = "twoway",
           data = ejFR_PR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(m_PR_shareI, m_PR_shareI2), stars = T)

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments = 1,
         ej_comment,
         #ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency_ej_share) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment)) %>% 
  left_join(ejFR_PR %>% distinct(agency, agency_ej_share))



predicted <- predictions(m_PR_shareI,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = agency_ej_share, 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment,
      label = agency) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , 
                  position = position_dodge(width = 0.010)  )  + 
  geom_text(check_overlap = T, 
            size = 3,
            color = "gray", 
            hjust = "left",
            #y = .7,
            aes(y = ifelse(ej_comment, estimate + 1.96*std.error + .05, NA))
            ) + 
  geom_hline(yintercept = 0, linetype = 2) + scale_x_continuous()+#labels = scales::percent) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = 'Share of Prior Rules Mentioning\n"Environmental Justice"',
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) + ylim(c(0,1))
```

For presentation 
```{r ej-m-PR-shareI-pres, fig.width=3, fig.height=3}
# ej-m-PR-shareI-pres  

# As a plot
p <- predicted %>%
  filter(ej_comment) %>% 
  ggplot() + 
  aes(x = agency_ej_share, 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment,
      label = agency) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , 
                  position = position_dodge(width = 0.010)  )  + 
  geom_text(check_overlap = T, 
            size = 3,
            color = "gray", 
            hjust = "left",
            #y = .7,
            aes(y = ifelse(agency %in% #share$agency,
                             c("FEMA", "EPA" , "PHMSA", "BOEM",  "DOE", "PHMSA", "BLM", "USDA",  #"OSM",  "DOT",
                               "COE"), 
                estimate + 1.96*std.error + .05, NA))
            ) + 
  geom_hline(yintercept = 0, linetype = 2) + scale_x_continuous()+#labels = scales::percent) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = 'Share of Prior Rules',
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        legend.position = "none",
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) + ylim(c(0,1))

p 

p$layers[1] <- NULL
p$layers[1] <- NULL


p + ylim(0,1) 
```

---

Coalition size with share interaction 



```{r ej-m-PR-shareI-ejcomments, fig.width=6, fig.height=2.5}
# ej-m-PR-ejcomments-shareI


# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency_ej_share = 0.41,
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)

predicted <- broom::augment(m_PR_share,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     )  


predicted <- predictions(m_PR_share2,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate, 
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment)) 

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = 'Coalition Size',
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---

### with Agency Fixed Effects 

(as well as President FE)




Two versions of this plot with different x-axes scale

```{r ej-m-PR-comments-agencyFE, fig.width=6, fig.height=2.5}
# ej-m-PR-comments-agencyFE

# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_agencyFE <- feglm (ej_fr ~ ej_comment*log(comments+1) + 
                          log(ej_comments_unique+1) 
                        | president + agency, se = "twoway",
           data = ejFR_PR, 
             family=binomial(link="logit"))

m_PR_agencyFE2 <- feglm (ej_fr ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 
                        | president + agency, se = "twoway",
           data = ejFR_PR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

# modelsummary(list(m_PR_agencyFE, m_PR_agencyFE2), stars = T)

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(comments = c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency = "EPA")%>% mutate(ej_comments_unique = as.numeric(ej_comment)) 

predicted <- broom::augment(m_PR_agencyFE,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  

predicted <- predictions(m_PR_agencyFE,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             
           str_c("\n     (N = ", n_ej_comment, " Rules)"))

# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    # scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) #+ ylim(c(0,1))

# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) + ylim(c(0,1))
```

For presentation

```{r ej-m-PR-comments-agencyFE-pres, fig.width=3, fig.height=2.5}
# ej-m-PR-comments-agencyFE-pres
# As a plot
p <- predicted %>%
  mutate(predicted = estimate -lag(estimate)) %>% 
  filter(comments<10001, ej_comment) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    # scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "Public Attention\n(Number of Comments)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        legend.position = "none",
        panel.grid.major.y = element_blank()) #+ ylim(c(0,1))

p 

p$layers[1] <- NULL

p + ylim(0,1) 
```


```{r ej-m-PR-comments-agencyFE-pres2, fig.width=5, fig.height=2.5}
# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    # scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Public Attention\n(Number of Comments)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) #+ ylim(c(0,1))
```

---

For presentation 

```{r ej-m-PR-ejcomments-agencyFE-pres, fig.width=3, fig.height=2.5}
# ej-m-PR-ejcomments-agencyFE-pres 


# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)



predicted <- broom::augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  


predicted <- predictions(m_PR_agencyFE,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate, 
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment)) 

# As a plot
p <- predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Responsiveness', 
       x = "Coalition Size",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "")  +
  theme(panel.border  = element_blank(),
        legend.position = "none",
        panel.grid.major.y = element_blank()) 

p 

p$layers[1] <- NULL

p + ylim(0,1) 
```

For paper 
```{r ej-m-PR-ejcomments-agencyFE, fig.width=6, fig.height=2.5}
# ej-m-PR-ejcomments-agencyFE


# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)


predicted <- broom::augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  


predicted <- predictions(m_PR_agencyFE,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate, 
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment)) 

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---



## Subsets

#### where EJ was raised

(as well as Agency and President FE)

This is just a robustness check. The effect of an EJ comment should capture differences. 

```{r ej-m-PR-ej, fig.width=6, fig.height=2.5}
# ej-m-PR-comments-agencyFE

# agencies with variation on DV
# ejFR_PR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

m_PR_agencyFE_ejcomment <- feglm (ej_fr ~ log(comments + 1) + log(ej_comments_unique + 1)
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR %>% filter(ej_comment), 
             family=binomial(link="logit"))

m_PR_agencyFE_ejcomment2 <- feglm (ej_fr ~ comments + 
                                    comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR %>% filter(ej_comment) %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(
  list(m_PR_agencyFE_ejcomment,
       m_PR_agencyFE_ejcomment2), 
  stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% filter(ej_comment) %>% 
  tidyr::expand(
    comments = c(1, 10,100,1000, 10000),
         ej_comment = TRUE,
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA")

# # broom does not work
# predicted <- broom::augment(m_PR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(m_PR_agencyFE_ejcomment2,
                newdata = values, type = "response") %>% 
  #FIXME 
  mutate(std.error = replace_na(std.error, NA)) %>%
  fill(std.error, .direction = "down")


predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWhere EJ is Raised by Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-m-PR-ej-ejcomments, fig.width=6, fig.height=2.5}
# ej-m-PR-ej-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% filter(ej_comment) %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)


# 
# predicted <- broom::augment(m_PR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(m_PR_agencyFE_ejcomment2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWhere EJ is Raised by Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---

#### EPA only 

This is just a robustness check. Agency fixed effects should capture differences. 

```{r ej-m-PR-epa, fig.width=6, fig.height=2.5}
# ej-m-PR-epa
m_PR_epa <- feglm(ej_fr ~ ej_comment*log(comments + 1) +
                                    log(ej_comments_unique + 1)
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR %>% filter(agency == "EPA"), 
             family=binomial(link="logit") )

m_PR_epa2 <- feglm (ej_fr ~ ej_comment*comments + 
                                    ej_comment*comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR %>% filter(agency == "EPA") %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(m_PR_epa,  m_PR_epa2), stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(
    comments = c(1, 10,100,1000, 10000),
         ej_comment = c(T, F),
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA") %>% mutate(ej_comments_unique = as.numeric(ej_comment))

# # broom does not work
# predicted <- broom::augment(m_PR_epa,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(m_PR_epa, newdata = values, type = "response") 


predicted %<>% 
  left_join(ejFR_PR %>% filter(agency =="EPA") %>%  count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in EPA Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-m-PR-epa-ejcomments, fig.width=6, fig.height=2.5}
# ej-m-PR-epa-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = c(T),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFR_PR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)


# predicted <- broom::augment(m_PR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(m_PR_epa2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% filter(agency == "EPA") %>%  count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in EPA Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```


---

#### Mass rules only 

This is just a robustness check. Agency fixed effects should capture differences. 

```{r ej-m-PR-mass, fig.width=6, fig.height=2.5}
# ej-m-PR-mass
m_PR_mass <- feglm(ej_fr ~ ej_comment*log(comments + 1) +
                                    log(ej_comments_unique + 1)
                        | president + agency, 
                        se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR ,# %>% filter(comments > 99), 
             family=binomial(link="logit") )

m_PR_mass2 <- feglm (ej_fr ~ ej_comment*comments + 
                                    ej_comment*comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president + agency, 
                        se = "twoway",
          # SUBSET DATA 
           data = ejFR_PR ,# %>% filter(comments > 99)%>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(m_PR_mass,  m_PR_mass2), stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% #filter(comments > 99) %>% 
  tidyr::expand(
    comments = c(100,1000, 10000),
         ej_comment = c(T, F),
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA")%>% mutate(ej_comments_unique = as.numeric(ej_comment))

# # broom does not work
# predicted <- broom::augment(m_PR_epa,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(m_PR_mass, newdata = values, type = "response") 


predicted %<>% 
  left_join(ejFR_PR %>% #filter(comments > 99) %>% 
              count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWith Mass Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-m-PR-mass-ejcomments, fig.width=6, fig.height=2.5}
# ej-m-PR-mass-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% # filter(comments > 99) %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = c(T),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFR_PR  %>% # filter(comments > 99) %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)



# predicted <- broom::augment(m_PR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(m_PR_mass2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFR_PR %>% # filter(comments > 99) %>%  
              count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWith Mass Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---



## Example dockets

Rules where the proposed rule did not address EJ, but comments did, and the Final Rule did.


```{r}

top_dockets <- ejFR_PR %>%
  filter(agency %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" ),
         ej_fr, # ej added 
         ej_comment) %>% # with ej comments  
  dplyr::select(docket_id, docket_title) %>% 
  distinct() %>% 
  pull(docket_id)

rules %>% 
  filter(docket_id %in% top_dockets) %>% 
  distinct(docket_id, docket_title, comments, ej_comments_unique) %>%  
  distinct() %>% 
  arrange(rev(docket_id)) %>% 
  kablebox()



# final rule text where the pr did not address ej
ejFR %>% 
  filter(docket_id %in% ejFR_PR$docket_id,
         docket_id %in% ejcomments$docket_id) %>% # EJ not in PR
  distinct(docket_id, title, summary) %>% 
  arrange(desc(docket_id)) %>% 
  kablebox()
```

## Example comments

Excerpts from comments mentioning "environmental justice" on proposed rules that did not address environmental justice: 
```{r}
ejcomments_ejFR_PR <- ejcomments %>% 
  filter(docket_id %in% ejFR_PR$docket_id) %>% 
  distinct(docket_id, title, summary, document_id) %>%
  group_by(docket_id) %>%
  slice_sample(n = 1) %>% 
  mutate(document_id = paste0("https://www.regulations.gov/comment/", document_id))

write_csv(ejcomments_ejFR_PR, here::here("data", "ejcomments_ejFR_PR.csv"))

ejcomments_ejFR_PR%>% kablebox()
```

---


# Proposed rules that **did** address EJ

```{r ej-data-ejPR}
# ej-data-ejPR

# Final Rules that where ej was mentioned in the NPRM
ejFRejPR <- allFR %>% 
  filter(#docket_id %in% allPR$docket_id,
         ej_fr,
         ej_pr)

# final rule text where the pr did address ej
change <- ejFR %>% dplyr::select(docket_id, final = summary) %>% 
  distinct() %>% 
  left_join(ejPR %>% 
              dplyr::select(docket_id, draft = summary) %>% distinct() ) %>% 
  filter(!is.na(draft))

# indicators 

# is there a comment mentioning ej
change %<>% mutate(ej_comment = docket_id %in% ejcomments$docket_id)

# did the final rule change
change %<>% mutate(change = !str_detect(draft, fixed(final, ignore_case = T) ))
  
########################################
# inspect 
change %>% 
  dplyr::select(docket_id, draft, final, ej_comment, change) %>% kablebox()

change %>% 
  dplyr::select(docket_id, draft, final, change) %>% kablebox()



# logical
change01 <- change %>% 
  distinct(docket_id, change) %>%
  # dedupe
  group_by(docket_id) %>% 
  slice_max(change) %>% #TODO sensitivity analysis 
  ungroup() 

ejFRejPR %<>% left_join(change01) 

ejFRejPR %>% count(change, ej_comment) %>% kablebox()

ejFRejPR %<>% filter(!is.na(change)) #TODO investigate NAs


save(ejFRejPR, file = here::here("data", "ejFRejPR.Rdata"))
```


```{r ej-comments-change, fig.width=6.5, fig.height=3.5}
# ej-comments-change
breaks <- c(1996, 2000, 2004, 2006, 2008, 2010, 2012, 2014, 2016, 2018, 2020)

# COMPARISON 2: no change vs change 
ejFRejPR %>% 
      filter(ej_pr == T, ej_fr == T) %>% 
  mutate(change = ifelse(change, #FIXME 
                         "EJ Text Changed", "EJ Text Unchanged")) %>% 
  filter(president2 %in% c("G.W. Bush 2", "Obama 1", "Obama 2", "Trump")) %>%
  filter(direct == "Draft Rule Published") %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ")) %>% 
  ggplot() + 
  aes(x = year, color = EJ_comment, shape = EJ_comment) + 
  # plot ej comments on top
  geom_jitter(alpha = .3, 
              aes(y = ifelse(ej_comment, NA, comments) ) ) + 
  geom_jitter(alpha = .3,
              aes(y = ifelse(ej_comment, comments, NA) ) ) +
  #geom_jitter(alpha = .3) + 
  facet_grid(change ~ president2, scales = "free_x") + 
  scale_y_log10(labels = scales::comma)  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Total Number of Comments\nper Rule (log scale)",
       color = "Comments Raised\nEnvironmental\nJustice Concerns",
       shape = "Comments Raised\nEnvironmental\nJustice Concerns") +
  #scale_x_discrete(breaks = breaks) + 
  scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1) )
```

Percent where the final rule did change how it addressed EJ

```{r ejejPR-winrate, fig.width=6, fig.height=2}
#ejejPR-winrate

winrate <- ejFRejPR %>% 
  count(ej_comment, change) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
  mutate(percent = round(`TRUE`/(`FALSE`+`TRUE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  count(ej_comment, change) %>% 
  left_join(winrate) %>%
  group_by(ej_comment) %>% 
  mutate(mean = mean(c(`TRUE`, `FALSE`)),
        EJ_comment = ifelse(ej_comment, "EJ Raised by Commenters", "EJ not Raised by Commenters")) %>% 
  ggplot() + 
  aes(x = EJ_comment, 
      y = n, 
      fill = change, 
      label = ifelse(change == ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(y = mean)) + 
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
facet_wrap("EJ_comment", scales = "free") + 
  labs(fill = "EJ section changed\nin Final Rule",
       y = "Proposed Rules") + 
  theme_void() +
  theme(axis.text.y = element_text(),
        axis.title.y = element_text(angle = 90),
        panel.grid.major.y = element_line(color = "grey"))
```

## Model 

### with president dummies
```{r ej-mejPR}
#ej-mejPR

mejPR <- glm(change ~ ej_comment*log(comments +1) +
                log(ej_comments_unique+1) +
              president,
           data = ejFRejPR, 
             family=binomial(link="logit"))

mejPRa <- glm(change ~ ej_comment*log(comments +1) +
                log(ej_comments_unique+1) +
              president + agency,
           data = ejFRejPR, 
             family=binomial(link="logit"))

modelsummary(mejPR, stars = T)
```


### with president fixed effects
```{r ej-mejPRFE}
#ej-mejPRFE

mejPRFE <- feglm(change ~ ej_comment*log(comments +1) +
                log(ej_comments_unique+1) | president,
           data = ejFRejPR, 
             family=binomial(link="logit"))



mejPR_pres <- feglm (change ~ ej_comment*log(comments+1) + 
                          log(ej_comments_unique+1)  + 
                      president
                        | agency,
           data = ejFRejPR, 
             family=binomial(link="logit"))

mejPR_pres2 <- feglm (change ~ ej_comment*comments + 
                          ej_comment*comments^2 + 
                          ej_comments_unique + 
                          ej_comments_unique^2 + 
                       president
                        |  agency,
           data = ejFRejPR %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))


modelsummary(list(mejPR, mejPR_pres, mejPR_pres2), stars = T)
```

## By president

```{r ejejPR-winrate-president, fig.height=3, fig.width=6}
# ejejPR-winrate-president-1

winrate <- ejFRejPR %>% 
  count(ej_comment, change, president) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  ungroup() %>% 
  count(ej_comment, change, president) %>% 
  left_join(winrate) %>%
  group_by(change) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = change, 
      label = ifelse(change== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ section changed\nin Final Rule",
       y = "",
       x = "Proposed Rules that Did Address EJ") + 
  theme(axis.ticks = element_blank(),
        panel.grid.major.y = element_blank())
```

---

### Predicted Probabilities by President

With the median number of comments, `r median(ejFRejPR$comments)`

```{r ej-mejPR-president-median,fig.width=6, fig.height=3}
#ej-mejPR-president-median

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         comments =#c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president ,
         agency = c("EPA", "NRC")) %>% 
  mutate(ej_comments_unique = as.numeric(ej_comment))




############# VERSION 1 WITH AGENCY INDICATORS 
predicted <- predictions(mejPRa,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


# As a plot
predicted %>% 
  mutate(agency = agency %>%
           str_replace("EPA","Environmental Protection Agency") %>% 
            str_replace("NRC","Nuclear Regulatory Commission")) %>% 
  ggplot() + 
  aes(x = president, ej_comment, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit, ymax = .fitted + 1.96*.se.fit), alpha = .7, show.legend = T, position = position_dodge(width = 0.50))  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Probability of Change in How Final Rule\nAddresses Environmental Justice', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules")+
       #caption = "EPA = Environmental Protection Agency\nNRC = Nuclear Regulatory Commission") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") #+ ylim(0,1) 


############# VERSION 2 WITH AGENCY FE 
predicted <- predictions(mejPR_pres,
                         newdata = values, type = "response") %>% 
  mutate(.fitted = estimate,
         .se.fit = std.error) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>% 
           str_c(", N = ", n_ej_comment))


# As a plot
predicted %>% 
  mutate(agency = agency %>%
           str_replace("EPA","Environmental Protection Agency") %>% 
            str_replace("NRC","Nuclear Regulatory Commission")) %>% 
  ggplot() + 
  aes(x = president, ej_comment, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit, ymax = .fitted + 1.96*.se.fit), alpha = .7, show.legend = T, position = position_dodge(width = 0.50))  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("agency", ncol = 1) +
  labs(y = 'Probability of Change in How Final Rule\nAddresses Environmental Justice', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules")+
       #caption = "EPA = Environmental Protection Agency\nNRC = Nuclear Regulatory Commission") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") #+ ylim(0,1) 
```

---

With the mean number of comments, `r mean(ejFRejPR$comments) %>% round() %>% as.integer()`

```{r ej-mejPR-president-mean,fig.width=6, fig.height=3}
#ej-mejPR-president-mean

# copy from median if needed
```

---

## By number of comments



Change in EJ section of the final rule by number of comments

Percent of rules that change when there are more or less than 10 comments.

```{r ejejPR-winrate-comments, fig.height=1.5, fig.width=5.5}
#ejejPR-winrate-comments

winrate <- ejFRejPR %>% 
  mutate(comments10 = comments > 9) %>% 
  count(change, comments10) %>% 
  group_by(comments10) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  mutate(comments10 = comments > 9) %>% 
  count(change, comments10) %>% 
  left_join(winrate) %>%
  mutate(comments = ifelse(comments10, "10 or more comments", "Fewer than 10 comments") ) %>% 
  ggplot() + 
  aes(x = n, y = comments, 
      fill = change, 
      label = percent %>% str_c("%")  ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0, check_overlap = T) + 
  #facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ section changed\nin Final Rule",
       x = "Proposed Rules that Did Address EJ",
       y = "")
```

### Predicted Probabilities by Number of Comments

Estimates across numbers of comments received.

```{r ej-mejPR-comments, fig.height = 2.5, fig.width=6}
#ej-mejPR-comments

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(comments = c(1,10,100,1000,10000) ,
         ej_comment,
         ej_comments_unique = median(ej_comments_unique),
         president = "Obama")

predicted <- augment(mejPR,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = factor(comments), y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) +
  ylim(0,1) 
```

---

## By Agency 

```{r ejejPR-winrate-agency, fig.width=6}
#ejejPR-winrate-agency

winrate <- ejFRejPR %>% 
  count(ej_comment, change, agency) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

# winrate 
ejFRejPR %>% count(agency, ej_comment, change)  %>% 
  add_count(agency) %>% 
  filter(nn > 2) %>% 
  #filter(agency == "EPA") %>%
  left_join(winrate) %>%
  group_by(change) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = change, 
      label = ifelse(change== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("agency", scales = "free", ncol = 2)+ 
  labs(fill = "EJ section changed\nin Final Rule",
       x = "Proposed Rules that Did Address EJ", 
       y = "") + 
  theme(axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 30),
        panel.grid.major.y = element_blank())
```

### Models 
```{r}
# interaction + agency dummies
mejPR_agency <- glm(change ~ ej_comment*log(comments+1) + 
                      log(ej_comments_unique+1) + #TODO this is colinear with above two, estimate nPR models
                      president +
                      agency,
                    data = ejFRejPR, 
                    family=binomial(link="logit"))


#tidy(mejPR_agency) %>% kablebox()

# modelsummary(mejPR_agency, stars =  T)
```

### Predicted Probabilities by Agency

```{r ej-mejPR-agency}
# ej-mejPR-agency

mejPR_agency <- glm(change ~ ej_comment*log(comments+1) + 
                      log(ej_comments_unique+1) +
                      president +
                      agency,
                    data = ejFRejPR, 
                    family=binomial(link="logit"))

mejPR_agency2 <- glm(change ~ ej_comment*comments + 
                      ej_comment*comments^2 + 
                      ej_comments_unique +
                      ej_comments_unique^2 + 
                      president +
                      agency,
                    data = ejFRejPR%>% mutate(comments = comments/1000), 
                    family=binomial(link="logit"))

# modelsummary( list(mejPR_agency, mejPR_agency2),stars =  T)


# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>%
  tidyr::expand(ej_comment,
         ej_comments_unique = median(comments) %>% round(),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency)

predicted <- augment(mejPR_agency,  
                     type.predict = "response",
                     newdata = values, 
                     se_fit = TRUE
                     ) 

# sadly this is failing
predicted <- predictions(mejPR_agency2,
                     newdata = values, type = "response") %>% 
  rename(.fitted = estimate,
         .se.fit = std.error) %>% 
  filter(!is.na(.fitted))

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  left_join(ejFRejPR %>% count(agency, name = "n_agency")) %>% 
  left_join( ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency, ", N = ", n_agency),
         EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))



# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7 , position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color = "",#color = "Environmental Justice"\nRaised by Comments', 
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules")  + 
  scale_y_continuous(breaks = c(0, .5,1)) +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank())
```

Agencies that have at least 300 comments on proposed rules that did not mention environmental justice (i.e., agencies where at least some of the rules in this dataset saw comments) and at least 3 rules where comments raised EJ concerns (i.e., agencies where EJ is somewhat salient). 

```{r ej-mejPR-agency-top}
#ej-mejPR-agency-top

ejFRejPR %>% 
  group_by(agency) %>% 
  count(agency, agency_ej_comments,sum(comments) )  %>%   
  kablebox()


top <- ejFRejPR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=300,
         agency_ej_comments >=3) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7 , position = position_dodge(width = 0.40) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments', 
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  scale_y_continuous(breaks = c(0,.5,1)) +
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_blank())
```


A more selective subset: Agencies that have at least 500 comments on proposed rules that did not mention environmental justice (i.e., agencies where at least some of the rules in this dataset saw more than a few comments) and at least 50 rules where comments raised EJ concerns (i.e., agencies where EJ is somewhat salient). 

```{r ej-mejPR-agency-toptop, fig.height=3}
#ej-mejPR-agency-toptop

# slightly more selective, requiring 100 comments
top <- ejFRejPR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=500,
         agency_ej_comments >=50) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .6)  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color = "",#color = '"Environmental Justice"\nRaised by Comments', 
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "Predicted Change in Final Rules") + 
  scale_y_continuous(breaks = c(0,.5,1)) +
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_blank())
```


## with Agency Share

(as well as president FE)

```{r ej-mejPR-comments-share, fig.width=6, fig.height=2.5}
#ej-mejPR-comments-share

mejPR_share <- feglm (change ~ ej_comment*log(comments+1) + log(ej_comments_unique+1) +
                           agency_ej_share
                     | president ,
           data = ejFRejPR, #se = "twoway",
             family=binomial(link="logit"))

mejPR_share2 <- feglm (change ~ ej_comment*comments +
                            ej_comment*comments^2 + 
                            ej_comments_unique + 
                            ej_comments_unique^2+
                           agency_ej_share
                     | president ,
           data = ejFRejPR%>% mutate(comments = comments/1000),# se = "twoway",
             family=binomial(link="logit"))

modelsummary(
  list(mejPR_share, mejPR_share2), stars = T)

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency = "EPA",
         agency_ej_share = 0.41) %>% mutate(ej_comments_unique = as.numeric(ej_comment))

# predicted <- augment(mejPR_agency,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      )  

predicted <- predictions(mejPR_share,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate,
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) # + ylim(0,1) 
```


```{r ej-mejPR-ejcomments-share, fig.width=6, fig.height=2.5}
#ej-mejPR-ejcomments-share

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA",
         agency_ej_share = 0.41) %>% 
  mutate(comments = ej_comments_unique)

values2 <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)


# predicted <- augment(mejPR_agency,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 


predicted <- predictions(mejPR_share2,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate,
         .se.fit = std.error)

predicted  %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) # + ylim(0,1) 
```

---

## with Agency Fixed Effects 

(as well as president FE)

```{r ej-mejPR-comments-agencyFE, fig.width=6, fig.height=2.5}
#ej-mejPR-comments-agencyFE

mejPR_agencyFE <- feglm (change ~ ej_comment*log(comments+1) + log(ej_comments_unique+1) 
                     | president + agency,
           data = ejFRejPR, se = "twoway",
             family=binomial(link="logit"))

mejPR_agencyFE2 <- feglm (change ~ ej_comment*comments +
                            ej_comment*comments^2 + 
                            ej_comments_unique + 
                            ej_comments_unique^2
                     | president + agency,
           data = ejFRejPR%>% mutate(comments = comments/1000), se = "twoway",
             family=binomial(link="logit"))

modelsummary(
  list(mejPR_agencyFE, mejPR_agencyFE2), stars = T)

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency = "EPA") %>% mutate(ej_comments_unique = as.numeric(ej_comment))

# predicted <- augment(mejPR_agency,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      )  

predicted <- predictions(mejPR_agencyFE,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate,
         .se.fit = std.error)

predicted %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) # + ylim(0,1) 
```


```{r ej-mejPR-ejcomments-agencyFE, fig.width=6, fig.height=2.5}
#ej-mejPR-ejcomments-agencyFE

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  mutate(comments = ej_comments_unique)

values2 <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA") 

values %<>% full_join(values2)

# predicted <- augment(mejPR_agency,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 


predicted <- predictions(mejPR_agencyFE2,
                         newdata = values, type = "response") %>% 
  rename(.fitted = estimate,
         .se.fit = std.error)

predicted  %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) # + ylim(0,1) 
```

---


## Subsets

#### where EJ was raised

(as well as Agency and President FE)

This is just a robustness check. The effect of an EJ comment should capture differences. 

```{r ej-mejPR-ej, fig.width=6, fig.height=2.5}
# ej-mejPR-ej

# agencies with variation on DV
# ejFRejPR %<>% group_by(agency) %>% mutate(dv_var = ej_fr %>% unique() %>% length()) %>% ungroup() %>% filter(dv_var > 1)

mejPR_agencyFE_ejcomment <- feglm (change ~ 
                                     log(comments + 1) +
                                     log(ej_comments_unique + 1)
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR %>% filter(ej_comment), 
             family=binomial(link="logit"))

mejPR_agencyFE_ejcomment2 <- feglm (change ~ comments + 
                                    comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR %>% filter(ej_comment)%>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(
  list(mejPR_agencyFE_ejcomment,
       mejPR_agencyFE_ejcomment2), 
  stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% filter(ej_comment) %>% 
  tidyr::expand(
    comments = c(1, 10,100,1000, 10000),
         ej_comment = TRUE,
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA")%>% mutate(ej_comments_unique = as.numeric(ej_comment))

# # broom does not work
# predicted <- broom::augment(mejPR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(mejPR_agencyFE_ejcomment2,
                newdata = values, type = "response") %>% 
  #FIXME 
  mutate(std.error = replace_na(std.error, NA)) %>%
  fill(std.error, .direction = "down")


predicted %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nText Chnages in Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWhere EJ is Raised by Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-mejPR-ej-ejcomments, fig.width=6, fig.height=2.5}
# ej-mejPR-ej-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% filter(ej_comment) %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = TRUE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

# 
# predicted <- broom::augment(mejPR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(mejPR_agencyFE_ejcomment2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nText Changes in Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWhere EJ is Raised by Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---

#### EPA only 

This is just a robustness check. Agency fixed effects should capture differences. 

```{r ej-mejPR-epa, fig.width=6, fig.height=2.5}
# ej-mejPR-epa
mejPR_epa <- feglm(change ~ ej_comment*log(comments + 1) +
                                    log(ej_comments_unique + 1)
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR %>% filter(agency == "EPA"), 
             family=binomial(link="logit") )

mejPR_epa2 <- feglm (change ~ ej_comment*comments + 
                                    ej_comment*comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president, 
                        #se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR %>% filter(agency == "EPA")%>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(mejPR_epa,  mejPR_epa2), stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(
    comments = c(1, 10,100,1000, 10000),
         ej_comment = c(T, F),
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA") %>% mutate(ej_comments_unique = as.numeric(ej_comment))

# # broom does not work
# predicted <- broom::augment(mejPR_epa,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(mejPR_epa, newdata = values, type = "response") 


predicted %<>% 
  left_join(ejFRejPR %>% filter(agency == "EPA") %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nText Changed in Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in EPA Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-mejPR-epa-ejcomments, fig.width=6, fig.height=2.5}
# ej-mejPR-eps-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = c(T),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFRejPR %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = 0,
         president = "Obama",
         agency = "EPA") 

values %<>% full_join(values2)


# predicted <- broom::augment(mejPR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(mejPR_epa2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFRejPR %>% filter(agency == "EPA") %>%  count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nText Changed Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in EPA Final Rules")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---

---

#### Mass rules only 

This is just a robustness check. Agency fixed effects should capture differences. 

```{r ej-mejPR-mass, fig.width=6, fig.height=2.5}
# ej-mejPR-mass
mejPR_mass <- feglm(change ~ ej_comment*log(comments + 1) +
                                    log(ej_comments_unique + 1)
                        | president + agency, 
                        se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR , # filter(comments > 99), 
             family=binomial(link="logit") )

mejPR_mass2 <- feglm (change ~ ej_comment*comments + 
                                    ej_comment*comments^2 +
                                    ej_comments_unique + 
                                    ej_comments_unique^2
                        | president + agency, 
                        se = "twoway",
          # SUBSET DATA 
           data = ejFRejPR,# %>% filter(comments > 99) %>% mutate(comments = comments/1000), 
             family=binomial(link="logit"))

modelsummary(list(mejPR_mass,  mejPR_mass2), stars = T)



# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% # filter(comments > 99) %>% 
  tidyr::expand(
    comments = c(100,1000, 10000),
         ej_comment = c(T, F),
         ej_comments_unique =  1,
         president = "Obama",
         agency = "EPA")%>% mutate(ej_comments_unique = as.numeric(ej_comment))

# # broom does not work
# predicted <- broom::augment(mejPR_epa,  
#                      type.predict = "response",
#                      newdata = values,
#                      se_fit = TRUE
#                      ) 

predicted <- predictions(mejPR_mass2, newdata = values, type = "response") 


predicted %<>% 
  left_join(ejFRejPR %>% # filter(comments > 99) %>% 
              count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%             str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(comments), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Total Number of Comments",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWith Mass Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

```{r ej-mejPR-mass-ejcomments, fig.width=6, fig.height=2.5}
# ej-m-PR-mass-ejcomments

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% # filter(comments > 99) %>% 
  tidyr::expand(ej_comments_unique = c(1, 10,100),
         ej_comment = c(T),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA") %>% 
  # set all comments to be EJ comments (we can't have one overall comment and 100 ej comments)
  mutate(comments = ej_comments_unique)

values2 <- ejFRejPR %>% # filter(comments > 99) %>% 
  tidyr::expand(ej_comments_unique = c(0),
         ej_comment = FALSE,
         comments = median(comments) %>% round(),
         president = "Obama",
         agency = "EPA",
         agency_ej_share = .41) 

values %<>% full_join(values2)




# predicted <- broom::augment(mejPR_agencyFE_ejcomment,  
#                      type.predict = "response",
#                      newdata = values, 
#                      se_fit = TRUE
#                      ) 
predicted <- predictions(mejPR_mass2,
                         newdata = values, type = "response")

predicted %<>% 
  left_join(ejFRejPR %>% # filter(comments > 99) %>%
            count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "Comments Address EJ", "No Comments Address EJ") %>%   str_c(", N = ", n_ej_comment))

# As a plot
predicted %>%
  ggplot() + 
  aes(x = factor(ej_comments_unique), 
      y = estimate, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = estimate - 1.96*std.error,
                  ymax = estimate + 1.96*std.error), 
                  alpha = .7 , position = position_dodge(width = 0.40)  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
    scale_y_continuous(breaks = c(0, .25, .5,.75, 1)) +
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma") +
coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nText Changes Final Rule', 
       x = "Number of Unique Comments\nRaising EJ Concerns",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules\nWith Mass Comments")  +
  theme(panel.border  = element_blank(),
        panel.grid.major.y = element_blank()) 
```

---



## Example dockets

Rules where the proposed rule did not address EJ, but comments did, and the Final Rule did.


EPA-R09-OAR-2010-0120	Revisions to California State Implementation Plans: Imperial County Air Pollution Control District:

>"EPA agrees it is important to consider environmental justice in our actions and we briefly addressed environmental justice principles in our proposal TSD. (171) ..." 

BUT "Environmental Justice" does not appear in the PR, and THERE IS NO OTHER TECHNICAL SUPPORTING DOCUMENT ON REGULATIONS.GOV. FOOTNOTE 171 REFERENCES THE PROPOSED RULE.

> This action will not have disproportionately high and adverse human health or environmental effects on minority, low-income or Tribal populations because it increases the level of environmental protection for all affected populations without having any disproportionately high and adverse human health or environmental effects on any population, including any minority or low-income population. Specially, EPA's limited approval and limited disapproval of Regulation VIII would have the affect of strengthening environmental requirements throughout ICAPCD, and would not relax environmental requirements in any area. Thus it promotes environmental justice by increasing the level of human health and environmental protection for an area where, **as the commenters note, relatively large portions of the population are low income and/or minority**."

---

EPA-R05-OAR-2007-0587	Final Approval of the Wisconsin NOx RACT Rules (NR 428)	

> "The commenter also states that multi facility averaging threatens environmental justice."

---

EPA-R05-OAR-2010-0034	Final Approval of PM 2.5 Clean Data Determination for Saint Louis: 

> "significant source of PM2.5 emissions in the Saint Louis area, and that the plant's operations raise environmental justice concerns. EPA reviewed air quality data throughout the Saint Louis area, including environmental justice areas."

--


EPA-HQ-OAR-2003-0048	National Emission Standards for Hazardous Air Pollutants: Plywood and Composite Wood Products	
> The rule also does not involve special consideration of environmental justice related issues as required by E.O. 12898."

---

EPA-HQ-OAR-2004-0094	National Emission Standards for Hazardous Air Pollutants: General Provisions	Impacts

> Comment: One commenter stated that EPA failed to comply with Executive Order 12898 on Environmental Justice. The commenter asserts that the amendments will adversely affect minority and low income communities around the sources.

> Response: Executive Order 12898 establishes a Federal policy for incorporating environmental justice into Federal agency actions by directing agencies to identify and address, as appropriate, disproportionately high and adverse human health or environmental effects of their programs, policies and activities on minority and low-income populations. The EPA has considered the impact of the proposal on minority and low income populations. **We do not believe that these amendments will have any adverse effects** on emissions during periods of SSM. Therefore, there should not be any adverse impact **on minority and low income populations** as a result of these amendments. The amendments do not affect the underlying requirement to minimize emissions during SSM events. **Owners or operators are still required to develop SSM plans to address emissions** during these periods. They are required to report immediately when the plans are not followed and semiannually when the plans are followed and emission limitations are exceeded (or could have been in the case of malfunctions) and describe steps taken to minimize emissions. **The only difference from current regulations is that the source is not required to follow the plan**, especially when the situation may call for other action or when safety considerations override following the plan as written.

---

Enhancements to Emergency Preparedness Regulations	NRC-2008-0122

> The NRC requested public comments on any environmental justice considerations that may be related to this rule and no comments were received.

BUT, a [comment by Richard Webster & Manna Jo Greene on Behalf of Hudson River Sloop Clearwater, Inc.](https://beta.regulations.gov/comment/NRC-2008-0122-0088) did address EJ:

> The rules and guidance are based on a fantasy world in which the terrain around nuclear power stations is perfectly flat, radiation plumes do not move up and down, the wind  blows at the same speed in a constant direction throughout an accident, and most people follow the instructions they are given about the need to evacuate.

> Need for Site-Specific Analysis of Transport Dependent Populations:
**The present guidance suggests that because 50% of residents would offer rides to those in need, approximately 50% of the transit dependent population in the EPZ would rideshare.** Criteria for Development of ETE Studies (April23, 2009) at 13. **This assumption fails to account for the likely separation of transit dependent environmental justice populations from more affluent populations. Furthermore, it takes no account of attitudes towards race and potential reluctance of whites to offer rides to African- Americans.** Instead of presuming that 50% of the transit dependent population will ride- share, the presumption should be that only a small percentage will rideshare unless the licensee can show that there are no geographical concentrations of transit dependent populations and that there is no racial or sociological bias with regard to ridesharing.

> ...people would be foolish to follow the directions of first responders if they are based on totally unrealistic modeling. Indeed, it is doubtful whether people would follow instructions even if they were based on the best predictions possible. **The experiences during the hurricane Katrina also underline that it is even more doubtful whether the response planned for environmental justice communities would actually materialize.**

---

Atlantic Highly Migratory Species: Atlantic Shark Management Measures; Final Amendment 5b	NOAA-NMFS-2013-0070	

> We received a total of 76 individual written comments on the proposed rule from fishermen, states, and other interested parties during the public comment period, including one comment from EarthJustice that included signatures from 19,716 individuals and another comment from Oceana that included signatures from 13,144 individuals.

>The EPA submitted a comment recommending additional environmental justice information...and include in the EIS whether the proposed alternatives have any potential for disproportionate adverse impacts to minority and low-income populations. The EPA also recommended that the EIS include the approaches used to foster public participation by these populations and describe outreach conducted to all other communities that could be affected by the project, because rural communities may be among the most vulnerable to health risks associated with the project.

> NMFS appreciates these recommendations from the EPA and has added additional information in the environmental justice discussion in Section 9.4 of the FEIS.

Between the time of the proposed rule in 2013 and the final Rule and Final Environmental Impact Statement (FEIS) in 2017, 

> Executive Order 12898 requires agencies to identify and address disproportionately high and adverse environmental effects of its regulations on minority and low-income populations. To determine whether environmental justice concerns exist, the demographics of the affected area should be examined to ascertain whether minority populations and low-income populations are present. If so, a determination must be made as to whether implementation of the alternatives may cause disproportionately high and adverse human health or environmental effects on these populations.
Community profile information are available in the 2006 Consolidated HMS FMP (Chapter 9), a recent report by MRAG Americas, and Jepson (2008) titled “Updated Profiles for HMS Dependent Fishing Communities” (Appendix E of Amendment 2 to the 2006 Consolidated HMS FMP), and in the **2015** HMS SAFE Report. The MRAG report updated community profiles presented in the 2006 Consolidated HMS FMP, and provided new social impacts assessments for HMS fishing communities along the Atlantic and Gulf of Mexico coasts. The 2011 and 2012 SAFE Reports (NMFS 2011 and NMFS 2012) include updated census data for all coastal Atlantic states, and some selected communities that are known centers of HMS fishing, processing or dealer activity. Demographic data indicate that coastal counties with fishing
9-9
communities are variable in terms of social indicators like income, employment, and race and ethnic composition.
The preferred alternatives were selected to minimize ecological and economic impacts and provide for the sustained participation of fishing communities. The preferred alternatives would not have any effects on human health nor are they expected to have any disproportionate social or economic effects on minority and low-income communities.

They also cited research published in the same year as the draft rule:

>Jepson and Colburn (2013) developed social indicators of vulnerability and resilience for 25 communities in the U.S. southeast and northeast regions selected for having a greater than average number of HMS permits associated with them.

---

Fisheries of the Exclusive Economic Zone Off Alaska: Chinook Salmon Bycatch Management in Bering Sea Pollock Fishery	NOAA-NMFS-2010-0032

>Comment 79: NOAA has the responsibility to modify the Council's recommendations to fulfill Federal obligations under ANILCA, ESA, Pacific Salmon Treaty, Environmental Justice, and Federal responsibility to tribal governments. NOAA should fulfill these obligations by not implementing Amendment 91 and insisting on the smaller bycatch rates proposed and supported by the most directly impacted communities.

>Response: NMFS has complied with all applicable laws, Executive Orders, and international obligations in approving and implementing Amendment 91, as documented in the EIS and ROD (see ADDRESSES).

> Comment 96: Subsistence users of the Yukon River, the vast majority of whom are Alaska Native and have the lowest per capita income in the United States, are clearly bearing a disproportionately high adverse environmental impact under Amendment 91. Under the concept of Environmental Justice, why does Amendment 91 result in tribal subsistence users bearing virtually all of the consequences resulting from past, present, and future wasteful bycatch by the pollock fleet? This violates all measures of fairness and fails to satisfy any consideration of environmental justice. The pollock fleet can best afford to make sacrifices in order to accomplish meaningful reductions in Chinook salmon bycatch.

> Response: NMFS acknowledges the comment. The EIS prepared for this action analyzes the environmental justice impacts of this action (see ADDRESSES).

---

EPA-R05-OAR-2020-0055
Removal of Ohio Nuisance Provision (3745-15-07) final rule	

>OAC 3745-15-07 [Ohio State Law] prohibits the “emission or escape into the open air from any source or sources whatsoever, of smoke, ashes, dust, dirt, grime, acids, fumes, gases, vapors, odors, or any other substances or combinations of substances, in such manner or in such amounts as to endanger the health, safety or welfare of the public, or cause unreasonable injury or damage to property.”

> On March 23, 2020, EPA proposed, under the authority of section 110(k)(6) of the CAA, to remove Ohio's nuisance rule from the Ohio State Implementation Plan (SIP) because it does not have a reasonable connection to the attainment and maintenance of the national ambient air quality standard (NAAQS) and EPA erred in approving it as part of the Ohio SIP.

> Comment 10: Commenters state that the NPRM would harm already vulnerable Ohioans by eliminating an important **environmental justice** tool. Commenters also raise concerns with the potential impact on other sensitive populations such as children, the elderly, and individuals with various health issues, including respiratory illnesses.

> Response: The purpose of this rulemaking action is to remove OAC 3745-15-07 from the Ohio SIP because it is not related to the implementation, maintenance, and enforcement of the NAAQS. This rulemaking action does not invalidate the Ohio law or affect its applicability to Ohio sources. **Facilities located in Ohio are still subject to the state nuisance rule.** EPA supports programs and activities that promote enforcement of health and environmental statutes in areas with minority populations and low-income populations and the protection of children, the elderly, and other vulnerable populations.



```{r}

top_dockets <- ejFRejPR %>%
  filter(agency %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" ),
         ej_fr, # ej added 
         ej_comment) %>% # with ej comments  
  dplyr::select(docket_id, docket_title) %>% 
  distinct() %>% 
  pull(docket_id)

rules %>% 
  filter(docket_id %in% top_dockets) %>% 
  distinct(docket_id, docket_title, comments, ej_comments_unique) %>%  
  distinct() %>% 
  arrange(rev(docket_id)) %>% 
  kablebox()



# final rule text where the pr did  address ej
ejFR %>% 
  filter(docket_id %in% ejFRejPR$docket_id,
         docket_id %in% ejcomments$docket_id) %>% # EJ not in PR
  distinct(docket_id, title, summary) %>% 
  arrange(desc(docket_id)) %>% 
  kablebox()
```

## Example comments

Excerpts from comments mentioning "environmental justice" on proposed rules that did address environmental justice: 
```{r}
ejcomments %>% 
  filter(docket_id %in% ejFRejPR$docket_id) %>% 
  distinct(docket_id, title, summary) %>%
  group_by(docket_id) %>%
  slice_sample(n = 1) %>% kablebox()
```

---


# Pairs

```{r ej-pairs, fig.height=4.9, fig.width=6.8}
# ej-pairs
pairs <- rules %>% 
  group_by(document_type, docket_id) %>% 
  mutate(max_year = min(year),
         max_year = ifelse(document_type != "Rule", NA, max_year)) %>% 
  ungroup() %>% 
  group_by(docket_id) %>%
  tidyr::fill(max_year, .direction = c("downup")) %>% # TODO by date not year
  #left_join(rules_raw) %>% 
  filter(!(document_type == "Proposed Rule" & year > max_year)) %>%
  group_by(docket_id, document_type) %>% 
  slice_head(n = 1) %>%
  # join in change
  left_join(change %>% distinct(docket_id, change)) %>% 
  mutate(ej_added = case_when(
    ej_fr & !ej_pr ~ "Measure 1:\n EJ Text Added",
    ej_pr & change ~ "Measure 2:\n EJ Text Changed",
    ej_pr &!change ~ "Measure 2:\n EJ Text Unchanged",
    !ej_pr & !ej_fr ~ "Measure 1:\n No EJ Text"
  ) ) %>% 
  mutate(study = case_when(
    ej_fr & !ej_pr ~ "DV = Text Added",
    ej_pr & change ~ "DV = Text Changed",
    ej_pr &!change ~ "DV = Text Changed",
    !ej_pr & !ej_fr ~ "DV = Text Added"
  ) ) %>% 
  mutate(ej_doc = case_when(
    document_type == "Proposed Rule" & ej_pr ~ "EJ Addressed",
    document_type == "Rule" & ej_fr ~ "EJ Addressed",
    TRUE ~ "EJ Not Addressed"
  )) %>% 
  mutate(ej_change = ifelse(ej_added %in% c("Measure 1:\n EJ Text Added", "Measure 2:\n EJ Text Changed"), "Change", "No Change")) %>% 
  group_by(docket_id) %>% 
  mutate(types = unique(document_type) %>% length()) %>% 
  ungroup()
           
           
pairs  %>% 
  filter(types > 1) %>%
  mutate(document_type = document_type %>% 
           str_replace("Proposed Rule", "Draft") %>% 
           str_replace("Rule", "Final")) %>% 
  drop_na(ej_added) %>% 
  ggplot() + 
  aes(x = document_type, group = docket_id,
      #y = posted_date, 
      y = year) +
  geom_line(alpha =.7, aes(linetype = ej_change), color = "black") +
  geom_point(alpha =.7, aes(color = ej_doc, shape = ej_doc)) + 
  theme_minimal() +
  facet_wrap("ej_added", nrow = 1) + 
  labs(y = "", x = "", color = "", linetype = "Dependent\nVariable", shape = "") + 
  theme(#legend.position = "top",
        legend.direction = "vertical",
        axis.text.x = element_text(angle = 45),
        axis.ticks = element_blank()) + 
  scale_color_viridis_d(option="plasma", begin = 0, end = .6, direction = 1)

# TODO make sure FR are all after PR 
# rules %<>% filter()
```



---


# Regression Tables

```{r}
library(modelsummary)
cm = c("ej_commentTRUE" = "EJ Comment", #
       "log(comments + 1)" = "Log(Comments+1)",
       "log(ej_comments_unique + 1)" = "Log(Unique EJ Comments+1)",
       "ej_commentTRUE:log(comments + 1)" = "EJ Comment*Log(Comments+1)",
       "comments" = "Total Comments",
       "I(comments^2)" = "Comments^2", #
       "ej_comments_unique" = "Unique EJ Comments", #
       "I(ej_comments_unique^2)" = "Unique EJ Comments^2", #
       "ej_commentTRUE:comments" = "EJ Comment*Total Comments", # 
       "ej_commentTRUE:I(comments^2)" = "EJ Comment*Comments^2",
       "agency_ej_share" = "Agency EJ Ratio",
       "presidentClinton" = "Clinton",  
"presidentG. W. Bush" = "Bush",
"presidentObama" = "Obama",
"presidentTrump" = "Trump",
"presidentBiden" = "Biden",
"ej_commentTRUE:presidentG. W. Bush"  = "Bush x EJ Comment", 
"ej_commentTRUE:presidentObama" = "Obama x EJ Comment",  
"ej_commentTRUE:presidentBiden" = "Biden x EJ Comment",  
"ej_commentTRUE:presidentTrump" = "Trump x EJ Comment") #

modelsFE <- list(
  "1" = m_PR_share, 
  "2" = m_PR_agencyFE,
  "3"  =  mejPR_share,
  "4" = mejPR_agencyFE
)

rowsFE <- tibble(
  term = c("Dependent Variable"),
  `1` = c("EJ Text Added"), 
  `2` =c("EJ Text Added"), 
  `3`  = c("EJ Text Changed"), 
  `4` = c("EJ Text Changed") #"✓"
)

attr(rowsFE, 'position') <- c(0)

# paper table fixest
modelsummary::modelsummary( modelsFE, 
                            stars = TRUE, 
                            coef_map = cm,
                            gof_omit = "R.*",
                          add_rows = rowsFE, 
                          notes = "") %>% 
  row_spec(row = 1, bold = T)%>%
  kable_styling(latex_options = c(scale_down = TRUE)) 
```

## Appendix tables 
```{r, include=FALSE}
# subsets 
modelsFE1 <- list(
  "2 EPA Only" = m_PR_epa,
    "2 Mass Only" = m_PR_mass,
    "2 EJ Only" = m_PR_agencyFE_ejcomment,
  "4 EPA Only"  =  mejPR_epa,  
  "4 Mass Only"  =  mejPR_mass,  
  "4 EJ Only"  =  mejPR_agencyFE_ejcomment
  )

rowsFE1 <- tibble(
  term = c("Dependent Variable"),
  `2 EPA Only` = c("EJ Added"), 
  `2  Mass Only` = c("EJ Added"), 
  `2 EJ Only` = c("EJ Added"), 
  `4 EPA Only` = c("EJ Changed"), 
  `4  Mass Only` = c("EJ Changed"), 
  `4 EJ Only` = c("EJ Changed")
)

attr(rowsFE1, 'position') <- c(0)

# app table fixest
modelsummary::modelsummary( modelsFE1, 
                            stars = TRUE, 
                            coef_map = cm,
                            gof_omit = "R.*",
                          add_rows = rowsFE1, 
                          notes = "") %>% 
  row_spec(row = 1, bold = T) %>%
  kable_styling(latex_options = c(scale_down = TRUE)) 

############################# 
# 2b 4b
modelsFE2 <- list(
  "2b" = m_PR_agencyFE2, 
  "2b EPA Only" = m_PR_epa2,
    "2b Mass Only" = m_PR_mass2,
    "2b EJ Only" = m_PR_agencyFE_ejcomment2,
  "4b"  =  mejPR_agencyFE2,
  "4b EPA Only"  =  mejPR_epa2,  
  "4b Mass Only"  =  mejPR_mass2,  
  "4b EJ Only"  =  mejPR_agencyFE_ejcomment2)

rowsFE2 <- tibble(
  term = c("Dependent Variable"),
  `2b` = c("EJ Added"), 
  `2b EPA Only` = c("EJ Added"), 
  `2b  Mass Only` = c("EJ Added"), 
  `2b EJ Only` = c("EJ Added"), 
  `4b` = c("EJ Changed"), 
  `4b EPA Only` = c("EJ Changed"), 
  `4b  Mass Only` = c("EJ Changed"), 
  `4b EJ Only` = c("EJ Changed")
)

attr(rowsFE2, 'position') <- c(0)

# app table fixest 2
modelsummary::modelsummary( modelsFE2, 
                            #stars = TRUE, 
                            coef_map = cm,
                            gof_omit = "R.*",
                          add_rows = rowsFE2, 
                          notes = "") %>% 
  row_spec(row = 1, bold = T)  %>%
  kable_styling(latex_options = c(scale_down = TRUE)) 
```

# Save `ej_models.Rdata`

```{r, cache=FALSE}
save(ejFR_PR, 
     ejFRejPR,
     cm,
     # paper table
     modelsFE,
     rowsFE,
     m_PR, m_PR_pres, m_PR_presI,m_PR_presIshare, m_PR_presIshareI,
     m_PR_agencyFE,
     mejPR,
     mejPR_agencyFE,
     #appendix table 1
      modelsFE1,
     rowsFE1,
     m_PR_epa,
     m_PR_mass,
     m_PR_agencyFE_ejcomment,
     mejPR_epa,
     mejPR_mass,
     mejPR_agencyFE_ejcomment,
     # appendix table 2 2b
     modelsFE2,
     rowsFE2,
     m_PR_agencyFE2,
     m_PR_epa2,
     m_PR_mass2,
     m_PR_agencyFE_ejcomment2,
     # appendix table 2 4b
     mejPR_agencyFE2,
     mejPR_epa2,
     mejPR_mass2,
     mejPR_agencyFE_ejcomment2,
     file = here::here("models", "ej_models.Rdata") ) 


ej_rates <- rules %>% 
  ungroup() %>% 
  distinct(docket_id, agency,agency_ej_share) %>% 
  count(agency, agency_ej_share) %>% 
  arrange(-agency_ej_share) %>%
  transmute(Agency = agency, 
            Rules = n, `Mention EJ` = agency_ej_share %>% percent(.01) ) 


ej_rates_president <- rules %>% 
  ungroup() %>% 
  distinct(docket_id,  ej_share_president, president) %>% 
  count(ej_share_president, president) %>% 
  arrange(-ej_share_president) %>%
  transmute(President = president,
            Rules = n, 
            `Mention EJ` = ej_share_president %>% percent(.01) ) 
  
  ej_rates_president_agency <- rules %>% 
  ungroup() %>% 
  distinct( agency_ej_share_president, president, agency) %>% 
  arrange(-agency_ej_share_president) %>%
      transmute(Agency = agency, 
                President = president,
            agency_ej_share_president  = agency_ej_share_president %>% percent(.01) ) %>% 
  pivot_wider(names_from =  President,
              values_from = agency_ej_share_president) 


save(ej_rates, ej_rates_president , ej_rates_president_agency,
     file = here::here("data", "ej_rates.Rdata"))
```

---

# Correlation with hand-coding 

```{r}
here::here("data", "comments_coded2021.Rdata") |> 
  str_replace("University of Michigan Dropbox/Devin Judge-Lord/ej", 
              "dissertation") |> 
  load()

cc <- comments_coded %>% 
  mutate(ejPR = docket_id %in% ejPR$docket_id,
         ejFR = docket_id %in% ejFR$docket_id,
         ejComment = document_id %in% ejcomments$id) %>% 
  left_join(change %>% dplyr::select(docket_id, change))


cc_PR <- filter(cc, !ejPR)
ccejPR <- filter(cc, ejPR)


cc_PR %>% 
  #filter(ejComment) %>% 
  ggplot() +
  aes(x = success, fill = ejFR) + 
  geom_density()

cc_PR %>% 
  #filter(ejComment) %>% 
  ggplot() +
  aes(x = success, fill = ejFR, color = ejComment) + 
  geom_histogram() + 
  facet_grid(ejFR ~ejComment)


# DV  = change 
ccejPR %>% 
  filter(ejComment) %>% # distinct(docket_id)
  ggplot() +
  aes(x = success, fill = change) + 
  geom_density()
```

## Across-org model 

## Within-org model


---

# TODO

*Data*

- [ ] Parse agencies by the frequency of their EJ analyis and interact this with e_comment as a more direct test of the policy receptivity hypothesis

- [X] Transform ej_comments to reduce corr with ej_comment

- [X] Dedupe PRs and FRs, or at least explore sensitivity to which of multiple PRs is used. Selected on`comments`. The PR with the most comments is most likely the main PR, but many have 0 comments. Perhaps also then on `posted_date`?  However, date is complicated. A later PR could be an extension of the comment period. A later FR could be a small amendment. New metadata may help with this.

- [ ] Compare new and old API metadata (comment counts are slightly different)

- [ ] New comment metadata from new API

- [ ] Compare % in change in 12898 sections vs. rule text vs. response to comment. This requires classifying responses to comment vs. adding 12898 section (in most cases, they are adding a 12898 section)

- [ ] Investigate other estimators & `clogit`

- [ ] Toss out data before 2005? I'm not seeing any systematic bias in it. It is incomplete and leads estimates for the Clinton years to be very uncertain. I hate to toss out good data just to avoid having to explain that, but maybe it is worth it.

- [ ] Controll for what elites view as a significant rule (OIRA)? Does this matter?

*Writing*

- [ ] Define activist. Who is mobilizing is not essential to the analysis, but it is essential to the interpretation of the results. If I am going to suggest that "EJ advocates/activists/...." seem to have an impact, I need to define who these people/orgs are and what they are up to. Maybe I can do this in the discussion rather than the data section? I am really not sure how to handle this. (The alternative is to just say "commenters" but that means dropping the activist/movements/representation framing). 

- [ ] Describe comment periods

- [ ] Example rule and comment in intro?

- [ ] Emphasize how EJ is more often re-framed by conservatives rather than outright ignored or argued against. 

- [ ] Do groups stratigically use EJ language with some agencies...maybe, but not so much. Not clear how this would bias results.

- [X] Be more explicit about the implications of EO for research design; courts only assess the 12898 analyses when the agency brings it up. If by citing it they incurred legal obligations, that would be a strong incentive not to cite it, but I don't think that is what is going on here because "compliance" with the EO is never the issue. Rather, the legal issue is whether disparate impacts are "relevant" to the rule and the agency's reasoned analysis. The EO and comments raising the EO just help make the case that these concerns and data are relevant when courts assess compliance with NEPA and the APA. 
For example, courts have criticized “bare-bones conclusion that [a minority or low-income population] would not be disproportionately harmed” and that failure to provide “meaningful discussion” of the disparate impacts of a rule “points to the agency’s failure to ‘consider an important aspect’ of the effects of the Rule.” I don't see any threats to inference with the EO--lawsuits are regular APA lawsuits, my only point was that the EO gives both agencies and commenters a reason to use the phrase "environmental justice," but I should be careful to be really clear about that since it got a lot of attention (in part because it appeared in the intro rather than the methods section, as it will in future drafts).

- [ ] Elaborate on Balla et al.


Theory 

- [ ] Clarify (re)distributive policy - Lowi

- [ ] Clarify that I'm not arguing against the dominance of well-resourced groups 

- [ ] More on ideas, discourse, framing in public policymaking (Stone, Schneider, Ingraham, etc.)


- [ ] Potential outcomes (have an example of each): 

 - EJ neither in comments, PR, nor FR
 - EJ in Comments only
 - EJ in FR only
 - EJ in Comments and FR only
 - EJ in PR, Comments, Rule

*Extensions*

- [ ] Compare topic proportions for cut and added text with comment texts.

- [ ] Replicate with "12898" and "climate change" + "global warming" (other ideas: class and race: "inequality" "low income" "racial" "minority population"?)


```{r to-scrape, include=FALSE, eval=FALSE}
ejdockets <- ejFR_PR %>% filter(ej_comment == T) %>% 
  full_join(
    ejFRejPR %>% filter(ej_comment == T, change == T) 
    ) %>% distinct(docket_id)
save(ejdockets, file = here::here("data", "ejdockets.Rdata"))

library(rvest)

html <- rvest::html("https://www.regulations.gov/comment/EPA-HQ-OPP-2020-0585-0024")

a <- tibble(text = html_text(html),
            link = html_attr(html, "href")) 

a
```



```{r old-data, include=FALSE, eval=FALSE}
ejcomments %<>% 
  mutate(summary = str_replace(summary, regex("<endeca_term>environmental</endeca_term> <endeca_term>justice</endeca_term>", ignore_case = T), "Environmental Justice")) %>% 
  filter(str_detect(summary,"Environmental Justice")|str_detect(comment_text, regex("environmental justice", ignore_case = T)))

```
